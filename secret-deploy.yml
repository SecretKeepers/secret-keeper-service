---
- name: Deploy Secret Service
  hosts: secret
  become: true
  gather_facts: false

  tasks:
    - name: Add host key to known_hosts
      command: ssh-keyscan 44.203.224.77 >> ~/.ssh/known_hosts

    - name: Set Docker Hub credentials from environment
      set_fact:
        docker_hub_username: "{{ lookup('env', 'DOCKER_HUB_USERNAME') }}"
        docker_hub_password: "{{ lookup('env', 'DOCKER_HUB_PASSWORD') }}"

    - name: Check if Docker Hub credentials are set
      fail:
        msg: "DOCKER_HUB_USERNAME and DOCKER_HUB_PASSWORD environment variables are required."
      when: docker_hub_username is not defined or docker_hub_password is not defined

    - name: Docker login
      command: "docker login -u '{{ docker_hub_username }}' -p '{{ docker_hub_password }}'"
      register: docker_login_result
      ignore_errors: true

    - name: Check Docker login status
      fail:
        msg: "Docker login failed. Please check your credentials."
      when: docker_login_result.rc != 0

    - name: Pull Docker images
      command: "docker-compose pull"
      args:
        chdir: "/home/ubuntu/secret-project"

    - name: Start Docker Compose services
      command: "docker-compose up -d"
      args:
        chdir: "/home/ubuntu/secret-project"
